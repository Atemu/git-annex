[[!comment format=mdwn
 username="joey"
 subject="""comment 1"""
 date="2018-08-28T16:16:03Z"
 content="""
Reproduced by creating 10000 files and running 
`git -c annex.queuesize=100 annex add -J8`

Apparently it runs two concurrent git adds
when flushing the queue in some circumstances.
The smaller queue size must make it easier to reproduce;
without it all 10000 files get added ok here.

It's not specific to v6 at all.

Hmm, worker threads don't actually get separate
Annex.repoqueue; a single queue is inherited
from the parent. Two worker threads could try
to flush the shared queue at the same time.

Since the queue updates are also done non-atomically,
which looks susceptable to races too,
I think each thread needs to get its own queue, but
only one thread ought to be allowed to flush its queue at a time.
"""]]
